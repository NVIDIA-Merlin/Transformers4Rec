<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Session-based Recommendation with XLNET &mdash; Transformers4Rec  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/mystnb.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Transformers4Rec
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../why_transformers4rec.html">Why Transformers4Rec?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_definition.html">Model Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training_eval.html">Training and Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline.html">End-to-end pipeline with NVIDIA Merlin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multi_gpu_train.html">Multi-GPU data-parallel training using the <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources.html">Additional Resources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Transformers4Rec</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Session-based Recommendation with XLNET</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright 2022 NVIDIA Corporation. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ==============================================================================</span>
</pre></div>
</div>
</div>
</div>
<img alt="https://developer.download.nvidia.com/notebooks/dlsw-notebooks/merlin_transformers4rec_getting-started-session-based-02-session-based-xlnet-with-pyt/nvidia_logo.png" src="https://developer.download.nvidia.com/notebooks/dlsw-notebooks/merlin_transformers4rec_getting-started-session-based-02-session-based-xlnet-with-pyt/nvidia_logo.png" />
<div class="tex2jax_ignore mathjax_ignore section" id="session-based-recommendation-with-xlnet">
<h1>Session-based Recommendation with XLNET<a class="headerlink" href="#session-based-recommendation-with-xlnet" title="Permalink to this headline"></a></h1>
<div class="section" id="imports-required-libraries">
<h2>Imports required libraries<a class="headerlink" href="#imports-required-libraries" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>

<span class="kn">import</span> <span class="nn">cudf</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">torch</span> 

<span class="kn">from</span> <span class="nn">transformers4rec</span> <span class="kn">import</span> <span class="n">torch</span> <span class="k">as</span> <span class="n">tr</span>
<span class="kn">from</span> <span class="nn">transformers4rec.torch.ranking_metric</span> <span class="kn">import</span> <span class="n">NDCGAt</span><span class="p">,</span> <span class="n">AvgPrecisionAt</span><span class="p">,</span> <span class="n">RecallAt</span>
<span class="kn">from</span> <span class="nn">transformers4rec.torch.utils.examples_utils</span> <span class="kn">import</span> <span class="n">wipe_memory</span>
<span class="kn">from</span> <span class="nn">merlin.io</span> <span class="kn">import</span> <span class="n">Dataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.8/dist-packages/tqdm/auto.py:22: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
/usr/lib/python3/dist-packages/requests/__init__.py:89: RequestsDependencyWarning: urllib3 (1.26.12) or chardet (3.0.4) doesn&#39;t match a supported version!
  warnings.warn(&quot;urllib3 ({}) or chardet ({}) doesn&#39;t match a supported &quot;
/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (NDCGAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (DCGAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (AvgPrecisionAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (PrecisionAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (RecallAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
</pre></div>
</div>
</div>
</div>
<p>Transformers4Rec library relies on a schema object to automatically build all necessary layers to represent, normalize and aggregate input features. As you can see below, <code class="docutils literal notranslate"><span class="pre">schema.pb</span></code> is a protobuf file that contains metadata including statistics about features such as cardinality, min and max values and also tags features based on their characteristics and dtypes (e.g., categorical, continuous, list, integer).</p>
</div>
<div class="section" id="set-the-schema-object">
<h2>Set the schema object<a class="headerlink" href="#set-the-schema-object" title="Permalink to this headline"></a></h2>
<p>We create the schema object by reading the <code class="docutils literal notranslate"><span class="pre">schema.pbtxt</span></code> file generated by NVTabular pipeline in the previous, <code class="docutils literal notranslate"><span class="pre">01-ETL-with-NVTabular</span></code>, notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin_standard_lib</span> <span class="kn">import</span> <span class="n">Schema</span>
<span class="c1"># import merlin.io</span>
<span class="c1"># from merlin.models.utils import schema_utils</span>
<span class="c1"># from merlin.schema import Schema, Tags</span>
<span class="c1"># from merlin.schema.io.tensorflow_metadata import TensorflowMetadata</span>
<span class="c1"># from merlin.schema import Schema</span>
<span class="n">SCHEMA_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INPUT_SCHEMA_PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;/workspace/data/processed_nvt/schema.pbtxt&quot;</span><span class="p">)</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">()</span><span class="o">.</span><span class="n">from_proto_text</span><span class="p">(</span><span class="n">SCHEMA_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">schema</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;name&#39;: &#39;session_id&#39;, &#39;type&#39;: &#39;INT&#39;, &#39;int_domain&#39;: {&#39;name&#39;: &#39;session_id&#39;, &#39;max&#39;: &#39;19877&#39;, &#39;is_categorical&#39;: True}, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;categorical&#39;], &#39;comment&#39;: [&#39;{&quot;num_buckets&quot;: null, &quot;freq_threshold&quot;: 0.0, &quot;max_size&quot;: 0.0, &quot;start_index&quot;: 1.0, &quot;cat_path&quot;: &quot;.//categories/unique.session_id.parquet&quot;, &quot;embedding_sizes&quot;: {&quot;cardinality&quot;: 19878.0, &quot;dimension&quot;: 409.0}, &quot;dtype_item_size&quot;: 64.0, &quot;is_list&quot;: false, &quot;is_ragged&quot;: false}&#39;]}}, {&#39;name&#39;: &#39;day-first&#39;, &#39;type&#39;: &#39;INT&#39;, &#39;annotation&#39;: {&#39;comment&#39;: [&#39;{&quot;dtype_item_size&quot;: 64.0, &quot;is_list&quot;: false, &quot;is_ragged&quot;: false}&#39;]}}, {&#39;name&#39;: &#39;item_id-count&#39;, &#39;type&#39;: &#39;INT&#39;, &#39;int_domain&#39;: {&#39;name&#39;: &#39;item_id&#39;, &#39;max&#39;: &#39;506&#39;, &#39;is_categorical&#39;: True}, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;categorical&#39;], &#39;comment&#39;: [&#39;{&quot;num_buckets&quot;: null, &quot;freq_threshold&quot;: 0.0, &quot;max_size&quot;: 0.0, &quot;start_index&quot;: 1.0, &quot;cat_path&quot;: &quot;.//categories/unique.item_id.parquet&quot;, &quot;embedding_sizes&quot;: {&quot;cardinality&quot;: 507.0, &quot;dimension&quot;: 52.0}, &quot;dtype_item_size&quot;: 32.0, &quot;is_list&quot;: false, &quot;is_ragged&quot;: false}&#39;]}}, {&#39;name&#39;: &#39;item_id-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;INT&#39;, &#39;int_domain&#39;: {&#39;name&#39;: &#39;item_id&#39;, &#39;max&#39;: &#39;506&#39;, &#39;is_categorical&#39;: True}, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;item_id&#39;, &#39;item&#39;, &#39;id&#39;, &#39;categorical&#39;], &#39;comment&#39;: [&#39;{&quot;num_buckets&quot;: null, &quot;freq_threshold&quot;: 0.0, &quot;max_size&quot;: 0.0, &quot;start_index&quot;: 1.0, &quot;cat_path&quot;: &quot;.//categories/unique.item_id.parquet&quot;, &quot;embedding_sizes&quot;: {&quot;cardinality&quot;: 507.0, &quot;dimension&quot;: 52.0}, &quot;dtype_item_size&quot;: 64.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}, {&#39;name&#39;: &#39;category-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;INT&#39;, &#39;int_domain&#39;: {&#39;name&#39;: &#39;category&#39;, &#39;max&#39;: &#39;137&#39;, &#39;is_categorical&#39;: True}, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;categorical&#39;], &#39;comment&#39;: [&#39;{&quot;num_buckets&quot;: null, &quot;freq_threshold&quot;: 0.0, &quot;max_size&quot;: 0.0, &quot;start_index&quot;: 1.0, &quot;cat_path&quot;: &quot;.//categories/unique.category.parquet&quot;, &quot;embedding_sizes&quot;: {&quot;cardinality&quot;: 138.0, &quot;dimension&quot;: 25.0}, &quot;dtype_item_size&quot;: 64.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}, {&#39;name&#39;: &#39;age_days-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;FLOAT&#39;, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;continuous&#39;], &#39;comment&#39;: [&#39;{&quot;dtype_item_size&quot;: 32.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}, {&#39;name&#39;: &#39;weekday_sin-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;FLOAT&#39;, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;continuous&#39;], &#39;comment&#39;: [&#39;{&quot;dtype_item_size&quot;: 32.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # You can select a subset of features for training</span>

<span class="c1"># You can select a subset of features for training</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">select_by_name</span><span class="p">([</span><span class="s1">&#39;item_id-list&#39;</span><span class="p">,</span> 
                                <span class="s1">&#39;category-list&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;weekday_sin-list&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;age_days-list&#39;</span>
                               <span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">schema</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;name&#39;: &#39;item_id-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;INT&#39;, &#39;int_domain&#39;: {&#39;name&#39;: &#39;item_id&#39;, &#39;max&#39;: &#39;506&#39;, &#39;is_categorical&#39;: True}, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;item_id&#39;, &#39;item&#39;, &#39;id&#39;, &#39;categorical&#39;], &#39;comment&#39;: [&#39;{&quot;num_buckets&quot;: null, &quot;freq_threshold&quot;: 0.0, &quot;max_size&quot;: 0.0, &quot;start_index&quot;: 1.0, &quot;cat_path&quot;: &quot;.//categories/unique.item_id.parquet&quot;, &quot;embedding_sizes&quot;: {&quot;cardinality&quot;: 507.0, &quot;dimension&quot;: 52.0}, &quot;dtype_item_size&quot;: 64.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}, {&#39;name&#39;: &#39;category-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;INT&#39;, &#39;int_domain&#39;: {&#39;name&#39;: &#39;category&#39;, &#39;max&#39;: &#39;137&#39;, &#39;is_categorical&#39;: True}, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;categorical&#39;], &#39;comment&#39;: [&#39;{&quot;num_buckets&quot;: null, &quot;freq_threshold&quot;: 0.0, &quot;max_size&quot;: 0.0, &quot;start_index&quot;: 1.0, &quot;cat_path&quot;: &quot;.//categories/unique.category.parquet&quot;, &quot;embedding_sizes&quot;: {&quot;cardinality&quot;: 138.0, &quot;dimension&quot;: 25.0}, &quot;dtype_item_size&quot;: 64.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}, {&#39;name&#39;: &#39;age_days-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;FLOAT&#39;, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;continuous&#39;], &#39;comment&#39;: [&#39;{&quot;dtype_item_size&quot;: 32.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}, {&#39;name&#39;: &#39;weekday_sin-list&#39;, &#39;value_count&#39;: {&#39;min&#39;: &#39;2&#39;, &#39;max&#39;: &#39;15&#39;}, &#39;type&#39;: &#39;FLOAT&#39;, &#39;annotation&#39;: {&#39;tag&#39;: [&#39;list&#39;, &#39;continuous&#39;], &#39;comment&#39;: [&#39;{&quot;dtype_item_size&quot;: 32.0, &quot;is_list&quot;: true, &quot;is_ragged&quot;: true}&#39;]}}]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="define-the-sequential-input-module">
<h2>Define the sequential input module<a class="headerlink" href="#define-the-sequential-input-module" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">TabularSequenceFeatures</span><span class="o">.</span><span class="n">from_schema</span><span class="p">(</span>
        <span class="n">schema</span><span class="p">,</span>
        <span class="n">max_sequence_length</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">continuous_projection</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">d_output</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">masking</span><span class="o">=</span><span class="s2">&quot;causal&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define XLNetConfig class and set default parameters for HF XLNet config  </span>
<span class="n">transformer_config</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">XLNetConfig</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
    <span class="n">d_model</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_head</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_layer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">total_seq_length</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>
<span class="c1"># Define the model block including: inputs, masking, projection and transformer block.</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">SequentialBlock</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">MLPBlock</span><span class="p">([</span><span class="mi">64</span><span class="p">]),</span> <span class="n">tr</span><span class="o">.</span><span class="n">TransformerBlock</span><span class="p">(</span><span class="n">transformer_config</span><span class="p">,</span> <span class="n">masking</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">masking</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Defines the evaluation top-N metrics and the cut-offs</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">NDCGAt</span><span class="p">(</span><span class="n">top_ks</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span> <span class="n">labels_onehot</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  
           <span class="n">RecallAt</span><span class="p">(</span><span class="n">top_ks</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span> <span class="n">labels_onehot</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

<span class="c1"># Define a head related to next item prediction task </span>
<span class="n">head</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">Head</span><span class="p">(</span>
    <span class="n">body</span><span class="p">,</span>
    <span class="n">tr</span><span class="o">.</span><span class="n">NextItemPredictionTask</span><span class="p">(</span><span class="n">weight_tying</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">),</span>
    <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Get the end-to-end Model class </span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (NDCGAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (DCGAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
/usr/local/lib/python3.8/dist-packages/torchmetrics/utilities/prints.py:36: UserWarning: Torchmetrics v0.9 introduced a new argument class property called `full_state_update` that has
                not been set for this class (RecallAt). The property determines if `update` by
                default needs access to the full metric state. If this is not the case, significant speedups can be
                achieved and we recommend setting this to `False`.
                We provide an checking function
                `from torchmetrics.utilities import check_forward_full_state_property`
                that can be used to check if the `full_state_update=True` (old and potential slower behaviour,
                default for now) or if `full_state_update=False` can be used safely.
                
  warnings.warn(*args, **kwargs)
</pre></div>
</div>
</div>
</div>
<p>Note that we can easily define an RNN-based model inside the <code class="docutils literal notranslate"><span class="pre">SequentialBlock</span></code> instead of a Transformer-based model. You can explore this <a class="reference external" href="https://github.com/NVIDIA-Merlin/Transformers4Rec/tree/main/examples/tutorial">tutorial</a> for a GRU-based model example.</p>
</div>
<div class="section" id="train-the-model">
<h2>Train the model<a class="headerlink" href="#train-the-model" title="Permalink to this headline"></a></h2>
<p>We use the NVTabular PyTorch Dataloader for optimized loading of multiple features from input parquet files. You can learn more about this data loader <a class="reference external" href="https://nvidia-merlin.github.io/NVTabular/main/training/pytorch.html">here</a>.</p>
</div>
<div class="section" id="set-training-arguments">
<h2><strong>Set Training arguments</strong><a class="headerlink" href="#set-training-arguments" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers4rec.config.trainer</span> <span class="kn">import</span> <span class="n">T4RecTrainingArguments</span>
<span class="kn">from</span> <span class="nn">transformers4rec.torch</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="c1"># Set hyperparameters for training </span>
<span class="n">train_args</span> <span class="o">=</span> <span class="n">T4RecTrainingArguments</span><span class="p">(</span><span class="n">data_loader_engine</span><span class="o">=</span><span class="s1">&#39;nvtabular&#39;</span><span class="p">,</span> 
                                    <span class="n">dataloader_drop_last</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">gradient_accumulation_steps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">per_device_train_batch_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> 
                                    <span class="n">per_device_eval_batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
                                    <span class="n">output_dir</span> <span class="o">=</span> <span class="s2">&quot;./tmp&quot;</span><span class="p">,</span> 
                                    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                                    <span class="n">lr_scheduler_type</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> 
                                    <span class="n">learning_rate_num_cosine_cycles_by_epoch</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                                    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                    <span class="n">max_sequence_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                                    <span class="n">report_to</span> <span class="o">=</span> <span class="p">[],</span>
                                    <span class="n">logging_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                    <span class="n">no_cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we add an argument <code class="docutils literal notranslate"><span class="pre">data_loader_engine='nvtabular'</span></code> to automatically load the features needed for training using the schema. The default value is nvtabular for optimized GPU-based data-loading. Optionally a PyarrowDataLoader (pyarrow) can also be used as a basic option, but it is slower and works only for small datasets, as the full data is loaded to CPU memory.</p>
</div>
<div class="section" id="daily-fine-tuning-training-over-a-time-window">
<h2>Daily Fine-Tuning: Training over a time window<a class="headerlink" href="#daily-fine-tuning-training-over-a-time-window" title="Permalink to this headline"></a></h2>
<p>Here we do daily fine-tuning meaning that we use the first day to train and second day to evaluate, then we use the second day data to train the model by resuming from the first step, and evaluate on the third day, so on so forth.</p>
<p>We have extended the HuggingFace transformers <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> class (PyTorch only) to support evaluation of RecSys metrics. In this example, the evaluation of the session-based recommendation model is performed using traditional Top-N ranking metrics such as Normalized Discounted Cumulative Gain (NDCG&#64;20) and Hit Rate (HR&#64;20). NDCG accounts for rank of the relevant item in the recommendation list and is a more fine-grained metric than HR, which only verifies whether the relevant item is among the top-n items. HR&#64;n is equivalent to Recall&#64;n when there is only one relevant item in the recommendation list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Instantiate the T4Rec Trainer, which manages training and evaluation for the PyTorch API</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="n">train_args</span><span class="p">,</span>
    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Define the output folder of the processed parquet files</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT_DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;INPUT_DATA_DIR&quot;</span><span class="p">,</span> <span class="s2">&quot;/workspace/data&quot;</span><span class="p">)</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OUTPUT_DIR&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">INPUT_DATA_DIR</span><span class="si">}</span><span class="s2">/sessions_by_day&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">start_time_window_index</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">final_time_window_index</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1">#Iterating over days of one week</span>
<span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_time_window_index</span><span class="p">,</span> <span class="n">final_time_window_index</span><span class="p">):</span>
    <span class="c1"># Set data </span>
    <span class="n">time_index_train</span> <span class="o">=</span> <span class="n">time_index</span>
    <span class="n">time_index_eval</span> <span class="o">=</span> <span class="n">time_index</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">train_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_index_train</span><span class="si">}</span><span class="s2">/train.parquet&quot;</span><span class="p">))</span>
    <span class="n">eval_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_index_eval</span><span class="si">}</span><span class="s2">/valid.parquet&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_paths</span><span class="p">)</span>
    
    <span class="c1"># Train on day related to time_index </span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Launch training for day </span><span class="si">%s</span><span class="s2"> are:&quot;</span> <span class="o">%</span><span class="n">time_index</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train_dataset_or_path</span> <span class="o">=</span> <span class="n">train_paths</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">reset_lr_scheduler</span><span class="p">()</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">global_step</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finished&#39;</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on the following day</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">eval_dataset_or_path</span> <span class="o">=</span> <span class="n">eval_paths</span>
    <span class="n">train_metrics</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">metric_key_prefix</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Eval results for day </span><span class="si">%s</span><span class="s2"> are:</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">time_index_eval</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">train_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span> 
    <span class="n">wipe_memory</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>***** Running training *****
  Num examples = 1664
  Num Epochs = 5
  Instantaneous batch size per device = 128
  Total train batch size (w. parallel, distributed &amp; accumulation) = 128
  Gradient Accumulation steps = 1
  Total optimization steps = 65
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/workspace/data/sessions_by_day/1/train.parquet&#39;]
********************
Launch training for day 1 are:
********************
</pre></div>
</div>
<div class="output text_html">
    <div>

      <progress value='65' max='65' style='width:300px; height:20px; vertical-align: middle;'></progress>
      [65/65 00:01, Epoch 5/5]
    </div>
    <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>Step</th>
      <th>Training Loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>50</td>
      <td>5.731000</td>
    </tr>
  </tbody>
</table><p></div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training completed. Do not forget to share your model on huggingface.co/models =)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finished
</pre></div>
</div>
<div class="output text_html">
<div>

  <progress value='12' max='6' style='width:300px; height:20px; vertical-align: middle;'></progress>
  [6/6 00:02]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>********************
Eval results for day 2 are:	

********************

 eval_/loss = 4.892789840698242
 eval_/next-item/ndcg_at_20 = 0.2019212245941162
 eval_/next-item/ndcg_at_40 = 0.24986284971237183
 eval_/next-item/recall_at_20 = 0.5104166865348816
 eval_/next-item/recall_at_40 = 0.7447916865348816
 eval_runtime = 0.1608
 eval_samples_per_second = 1193.821
 eval_steps_per_second = 37.307
[&#39;/workspace/data/sessions_by_day/2/train.parquet&#39;]
********************
Launch training for day 2 are:
********************
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>***** Running training *****
  Num examples = 1664
  Num Epochs = 5
  Instantaneous batch size per device = 128
  Total train batch size (w. parallel, distributed &amp; accumulation) = 128
  Gradient Accumulation steps = 1
  Total optimization steps = 65
</pre></div>
</div>
<div class="output text_html">
    <div>

      <progress value='65' max='65' style='width:300px; height:20px; vertical-align: middle;'></progress>
      [65/65 00:01, Epoch 5/5]
    </div>
    <table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>Step</th>
      <th>Training Loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>50</td>
      <td>4.795200</td>
    </tr>
  </tbody>
</table><p></div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training completed. Do not forget to share your model on huggingface.co/models =)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finished
********************
Eval results for day 3 are:	

********************

 eval_/loss = 4.611485481262207
 eval_/next-item/ndcg_at_20 = 0.1681433618068695
 eval_/next-item/ndcg_at_40 = 0.22220981121063232
 eval_/next-item/recall_at_20 = 0.484375
 eval_/next-item/recall_at_40 = 0.7447916865348816
 eval_runtime = 0.1687
 eval_samples_per_second = 1138.188
 eval_steps_per_second = 35.568
CPU times: user 15.9 s, sys: 247 ms, total: 16.1 s
Wall time: 5.28 s
</pre></div>
</div>
</div>
</div>
<div class="section" id="re-compute-eval-metrics-of-validation-data">
<h3>Re-compute eval metrics of validation data<a class="headerlink" href="#re-compute-eval-metrics-of-validation-data" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_data_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_index_eval</span><span class="si">}</span><span class="s2">/valid.parquet&quot;</span><span class="p">))</span>

<span class="c1"># set new data from day 7</span>
<span class="n">eval_metrics</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_data_paths</span><span class="p">,</span> <span class="n">metric_key_prefix</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">eval_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eval_metrics</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
</pre></div>
</div>
</div>
</div>
<p>That’s it!<br />
You have just trained your session-based recommendation model using Transformers4Rec.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model(
  (heads): ModuleList(
    (0): Head(
      (body): SequentialBlock(
        (0): TabularSequenceFeatures(
          (to_merge): ModuleDict(
            (continuous_module): SequentialBlock(
              (0): ContinuousFeatures(
                (filter_features): FilterFeatures()
                (_aggregation): ConcatFeatures()
              )
              (1): SequentialBlock(
                (0): DenseBlock(
                  (0): Linear(in_features=2, out_features=64, bias=True)
                  (1): ReLU(inplace=True)
                )
              )
              (2): AsTabular()
            )
            (categorical_module): SequenceEmbeddingFeatures(
              (filter_features): FilterFeatures()
              (embedding_tables): ModuleDict(
                (item_id-list): Embedding(507, 64, padding_idx=0)
                (category-list): Embedding(138, 64, padding_idx=0)
              )
            )
          )
          (_aggregation): ConcatFeatures()
          (projection_module): SequentialBlock(
            (0): DenseBlock(
              (0): Linear(in_features=192, out_features=100, bias=True)
              (1): ReLU(inplace=True)
            )
          )
          (_masking): CausalLanguageModeling()
        )
        (1): SequentialBlock(
          (0): DenseBlock(
            (0): Linear(in_features=100, out_features=64, bias=True)
            (1): ReLU(inplace=True)
          )
        )
        (2): TansformerBlock(
          (transformer): XLNetModel(
            (word_embedding): Embedding(1, 64)
            (layer): ModuleList(
              (0): XLNetLayer(
                (rel_attn): XLNetRelativeAttention(
                  (layer_norm): LayerNorm((64,), eps=0.03, elementwise_affine=True)
                  (dropout): Dropout(p=0.3, inplace=False)
                )
                (ff): XLNetFeedForward(
                  (layer_norm): LayerNorm((64,), eps=0.03, elementwise_affine=True)
                  (layer_1): Linear(in_features=64, out_features=256, bias=True)
                  (layer_2): Linear(in_features=256, out_features=64, bias=True)
                  (dropout): Dropout(p=0.3, inplace=False)
                )
                (dropout): Dropout(p=0.3, inplace=False)
              )
              (1): XLNetLayer(
                (rel_attn): XLNetRelativeAttention(
                  (layer_norm): LayerNorm((64,), eps=0.03, elementwise_affine=True)
                  (dropout): Dropout(p=0.3, inplace=False)
                )
                (ff): XLNetFeedForward(
                  (layer_norm): LayerNorm((64,), eps=0.03, elementwise_affine=True)
                  (layer_1): Linear(in_features=64, out_features=256, bias=True)
                  (layer_2): Linear(in_features=256, out_features=64, bias=True)
                  (dropout): Dropout(p=0.3, inplace=False)
                )
                (dropout): Dropout(p=0.3, inplace=False)
              )
            )
            (dropout): Dropout(p=0.3, inplace=False)
          )
          (masking): CausalLanguageModeling()
        )
      )
      (prediction_task_dict): ModuleDict(
        (next-item): NextItemPredictionTask(
          (sequence_summary): SequenceSummary(
            (summary): Identity()
            (activation): Identity()
            (first_dropout): Identity()
            (last_dropout): Identity()
          )
          (metrics): ModuleList(
            (0): NDCGAt()
            (1): RecallAt()
          )
          (loss): NLLLoss()
          (embeddings): SequenceEmbeddingFeatures(
            (filter_features): FilterFeatures()
            (embedding_tables): ModuleDict(
              (item_id-list): Embedding(507, 64, padding_idx=0)
              (category-list): Embedding(138, 64, padding_idx=0)
            )
          )
          (item_embedding_table): Embedding(507, 64, padding_idx=0)
          (masking): CausalLanguageModeling()
          (pre): Block(
            (module): NextItemPredictionTask(
              (item_embedding_table): Embedding(507, 64, padding_idx=0)
              (log_softmax): LogSoftmax(dim=-1)
            )
          )
        )
      )
    )
  )
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">hf_format</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">input_schema</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.8/dist-packages/merlin/schema/tags.py:148: UserWarning: Compound tags like Tags.ITEM_ID have been deprecated and will be removed in a future version. Please use the atomic versions of these tags, like [&lt;Tags.ITEM: &#39;item&#39;&gt;, &lt;Tags.ID: &#39;id&#39;&gt;].
  warnings.warn(
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>tags</th>
      <th>dtype</th>
      <th>is_list</th>
      <th>is_ragged</th>
      <th>properties.int_domain.min</th>
      <th>properties.int_domain.max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>age_days-list</td>
      <td>(Tags.CONTINUOUS, Tags.LIST)</td>
      <td>float32</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>weekday_sin-list</td>
      <td>(Tags.CONTINUOUS, Tags.LIST)</td>
      <td>float32</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>item_id-list</td>
      <td>(Tags.ID, Tags.ITEM, Tags.CATEGORICAL, Tags.IT...</td>
      <td>int64</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>506</td>
    </tr>
    <tr>
      <th>3</th>
      <td>category-list</td>
      <td>(Tags.CATEGORICAL, Tags.LIST)</td>
      <td>int64</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>137</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Create a dict of tensors</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">train_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train_dataset_or_path</span> <span class="o">=</span> <span class="n">dataset</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_train_dataloader</span><span class="p">()</span>
<span class="n">train_dict</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traced_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traced_model</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">TopLevelTracedModule</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">model</span><span class="p">(</span><span class="n">train_dict</span><span class="p">),</span>
    <span class="n">traced_model</span><span class="p">(</span><span class="n">train_dict</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_schema</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_schema</span>
<span class="n">output_schema</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output_schema</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_schema</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>tags</th>
      <th>dtype</th>
      <th>is_list</th>
      <th>is_ragged</th>
      <th>properties.int_domain.min</th>
      <th>properties.int_domain.max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>age_days-list</td>
      <td>(Tags.CONTINUOUS, Tags.LIST)</td>
      <td>float32</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>weekday_sin-list</td>
      <td>(Tags.CONTINUOUS, Tags.LIST)</td>
      <td>float32</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>item_id-list</td>
      <td>(Tags.ID, Tags.ITEM, Tags.CATEGORICAL, Tags.IT...</td>
      <td>int64</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>506</td>
    </tr>
    <tr>
      <th>3</th>
      <td>category-list</td>
      <td>(Tags.CATEGORICAL, Tags.LIST)</td>
      <td>int64</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>137</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.core.dispatch</span> <span class="kn">import</span> <span class="n">make_df</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag</span> <span class="kn">import</span> <span class="n">Ensemble</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.pytorch</span> <span class="kn">import</span> <span class="n">PredictPyTorch</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">merlin.systems.triton.utils</span> <span class="kn">import</span> <span class="n">run_ensemble_on_tritonserver</span>  <span class="c1"># noqa</span>

<span class="n">torch_op</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">column_names</span> <span class="o">&gt;&gt;</span> <span class="n">PredictPyTorch</span><span class="p">(</span>
    <span class="n">traced_model</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">,</span> <span class="n">output_schema</span>
<span class="p">)</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">Ensemble</span><span class="p">(</span><span class="n">torch_op</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">)</span>
<span class="n">ens_config</span><span class="p">,</span> <span class="n">node_configs</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;./models&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.8/dist-packages/merlin/schema/tags.py:148: UserWarning: Compound tags like Tags.ITEM_ID have been deprecated and will be removed in a future version. Please use the atomic versions of these tags, like [&lt;Tags.ITEM: &#39;item&#39;&gt;, &lt;Tags.ID: &#39;id&#39;&gt;].
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<p>Create a dataframe to send as a request. We need a dataset where the list columns are padded to the max sequence lenght that was set in the ETL pipeline.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">eval_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># trainer.test_dataset_or_path = dataset</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">get_test_dataloader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">test_dict</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">))</span>

<span class="n">df_cols</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">train_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">column_names</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">input_schema</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>

        <span class="n">df_cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">df_cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_cols</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">make_df</span><span class="p">(</span><span class="n">df_cols</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(128, 4)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age_days-list</th>
      <th>weekday_sin-list</th>
      <th>item_id-list</th>
      <th>category-list</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[0.37403864, 0.42758772, 0.93743354, 0.0, 0.0,...</td>
      <td>[0.9351001, 0.91299504, 0.9785595, 0.0, 0.0, 0...</td>
      <td>[30, 24, 200, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</td>
      <td>[7, 6, 40, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[0.9327483, 0.36575532, 0.13967341, 0.45479113...</td>
      <td>[0.5046626, 0.17492707, 0.12539314, 0.6640924,...</td>
      <td>[190, 10, 7, 55, 27, 3, 6, 184, 0, 0, 0, 0, 0,...</td>
      <td>[36, 3, 2, 11, 6, 4, 2, 36, 0, 0, 0, 0, 0, 0, ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>[0.57168996, 0.48532194, 0.89944935, 0.2171675...</td>
      <td>[0.93685514, 0.5638695, 0.76670134, 0.6797855,...</td>
      <td>[153, 8, 46, 58, 21, 19, 31, 15, 4, 104, 0, 0,...</td>
      <td>[28, 2, 10, 11, 5, 5, 7, 3, 2, 18, 0, 0, 0, 0,...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>[0.8520663, 0.6690395, 0.92268515, 0.99163777,...</td>
      <td>[0.58499664, 0.45736608, 0.88926136, 0.9139287...</td>
      <td>[19, 28, 23, 34, 18, 10, 0, 0, 0, 0, 0, 0, 0, ...</td>
      <td>[5, 6, 6, 7, 5, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>[0.67542243, 0.65952307, 0.7467189, 0.6136317,...</td>
      <td>[0.09077961, 0.7920753, 0.35881928, 0.8545563,...</td>
      <td>[17, 27, 70, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</td>
      <td>[5, 6, 14, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===========================================</span>
<span class="c1"># Send request to Triton and check response</span>
<span class="c1"># ===========================================</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">run_ensemble_on_tritonserver</span><span class="p">(</span>
    <span class="s1">&#39;./models&#39;</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">input_schema</span><span class="o">.</span><span class="n">column_names</span><span class="p">],</span> <span class="n">output_schema</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span> <span class="s2">&quot;ensemble_model&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>I1123 22:15:22.928458 2118 pinned_memory_manager.cc:240] Pinned memory pool is created at &#39;0x7f428e000000&#39; with size 268435456
I1123 22:15:22.928899 2118 cuda_memory_manager.cc:105] CUDA memory pool is created on device 0 with size 67108864
I1123 22:15:22.931602 2118 model_lifecycle.cc:459] loading: 0_predictpytorch:1
I1123 22:15:23.299444 2118 libtorch.cc:1983] TRITONBACKEND_Initialize: pytorch
I1123 22:15:23.299463 2118 libtorch.cc:1993] Triton TRITONBACKEND API version: 1.10
I1123 22:15:23.299469 2118 libtorch.cc:1999] &#39;pytorch&#39; TRITONBACKEND API version: 1.10
I1123 22:15:23.299488 2118 libtorch.cc:2032] TRITONBACKEND_ModelInitialize: 0_predictpytorch (version 1)
W1123 22:15:23.300039 2118 libtorch.cc:284] skipping model configuration auto-complete for &#39;0_predictpytorch&#39;: not supported for pytorch backend
I1123 22:15:23.300768 2118 libtorch.cc:313] Optimized execution is enabled for model instance &#39;0_predictpytorch&#39;
I1123 22:15:23.300780 2118 libtorch.cc:332] Cache Cleaning is disabled for model instance &#39;0_predictpytorch&#39;
I1123 22:15:23.300786 2118 libtorch.cc:349] Inference Mode is enabled for model instance &#39;0_predictpytorch&#39;
I1123 22:15:23.300790 2118 libtorch.cc:444] NvFuser is not specified for model instance &#39;0_predictpytorch&#39;
I1123 22:15:23.301026 2118 libtorch.cc:2076] TRITONBACKEND_ModelInstanceInitialize: 0_predictpytorch (GPU device 0)
I1123 22:15:24.229933 2118 model_lifecycle.cc:693] successfully loaded &#39;0_predictpytorch&#39; version 1
I1123 22:15:24.230204 2118 model_lifecycle.cc:459] loading: ensemble_model:1
I1123 22:15:24.230490 2118 model_lifecycle.cc:693] successfully loaded &#39;ensemble_model&#39; version 1
I1123 22:15:24.230584 2118 server.cc:561] 
+------------------+------+
| Repository Agent | Path |
+------------------+------+
+------------------+------+

I1123 22:15:24.230668 2118 server.cc:588] 
+---------+---------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Backend | Path                                                    | Config                                                                                                                                                        |
+---------+---------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+
| pytorch | /opt/tritonserver/backends/pytorch/libtriton_pytorch.so | {&quot;cmdline&quot;:{&quot;auto-complete-config&quot;:&quot;true&quot;,&quot;min-compute-capability&quot;:&quot;6.000000&quot;,&quot;backend-directory&quot;:&quot;/opt/tritonserver/backends&quot;,&quot;default-max-batch-size&quot;:&quot;4&quot;}} |
+---------+---------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------+

I1123 22:15:24.230751 2118 server.cc:631] 
+------------------+---------+--------+
| Model            | Version | Status |
+------------------+---------+--------+
| 0_predictpytorch | 1       | READY  |
| ensemble_model   | 1       | READY  |
+------------------+---------+--------+

I1123 22:15:24.282945 2118 metrics.cc:650] Collecting metrics for GPU 0: Quadro GV100
I1123 22:15:24.283260 2118 tritonserver.cc:2214] 
+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Option                           | Value                                                                                                                                                                                        |
+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| server_id                        | triton                                                                                                                                                                                       |
| server_version                   | 2.25.0                                                                                                                                                                                       |
| server_extensions                | classification sequence model_repository model_repository(unload_dependents) schedule_policy model_configuration system_shared_memory cuda_shared_memory binary_tensor_data statistics trace |
| model_repository_path[0]         | ./models                                                                                                                                                                                     |
| model_control_mode               | MODE_NONE                                                                                                                                                                                    |
| strict_model_config              | 0                                                                                                                                                                                            |
| rate_limit                       | OFF                                                                                                                                                                                          |
| pinned_memory_pool_byte_size     | 268435456                                                                                                                                                                                    |
| cuda_memory_pool_byte_size{0}    | 67108864                                                                                                                                                                                     |
| response_cache_byte_size         | 0                                                                                                                                                                                            |
| min_supported_compute_capability | 6.0                                                                                                                                                                                          |
| strict_readiness                 | 1                                                                                                                                                                                            |
| exit_timeout                     | 30                                                                                                                                                                                           |
+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

I1123 22:15:24.285008 2118 grpc_server.cc:4610] Started GRPCInferenceService at localhost:8001
I1123 22:15:24.285227 2118 http_server.cc:3316] Started HTTPService at 0.0.0.0:8000
I1123 22:15:24.326845 2118 http_server.cc:178] Started Metrics Service at 0.0.0.0:8002
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Signal (2) received.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>I1123 22:15:26.364164 2118 server.cc:262] Waiting for in-flight requests to complete.
I1123 22:15:26.364179 2118 server.cc:278] Timeout 30: Found 0 model versions that have in-flight inferences
I1123 22:15:26.364255 2118 server.cc:293] All models are stopped, unloading models
I1123 22:15:26.364263 2118 server.cc:300] Timeout 30: Found 2 live models and 0 in-flight non-inference requests
I1123 22:15:26.364287 2118 model_lifecycle.cc:578] successfully unloaded &#39;ensemble_model&#39; version 1
I1123 22:15:26.364592 2118 libtorch.cc:2110] TRITONBACKEND_ModelInstanceFinalize: delete instance state
I1123 22:15:26.372137 2118 libtorch.cc:2055] TRITONBACKEND_ModelFinalize: delete model state
I1123 22:15:26.372333 2118 model_lifecycle.cc:578] successfully unloaded &#39;0_predictpytorch&#39; version 1
I1123 22:15:27.364444 2118 server.cc:300] Timeout 29: Found 0 live models and 0 in-flight non-inference requests
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">response</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;next-item&#39;: array([[-7.9947233, -8.747803 , -3.4068425, ..., -7.914096 , -8.571636 ,
         -7.815837 ],
        [-7.977386 , -8.727583 , -3.3388414, ..., -7.9091067, -8.508778 ,
         -7.7708635],
        [-8.000487 , -8.737406 , -3.4030848, ..., -7.921053 , -8.557445 ,
         -7.798526 ],
        ...,
        [-7.998163 , -8.739789 , -3.3824148, ..., -7.9103565, -8.550226 ,
         -7.8002963],
        [-7.9968286, -8.753717 , -3.3801503, ..., -7.9066863, -8.55961  ,
         -7.794828 ],
        [-8.01243  , -8.753323 , -3.3656597, ..., -7.8982997, -8.546498 ,
         -7.7921886]], dtype=float32)}
</pre></div>
</div>
</div>
</div>
<p>We return a response for each request in the df. Each row in the <code class="docutils literal notranslate"><span class="pre">response['next-item']</span></code> array corresponds to the logit values per item in the catalog and for the OOV item.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;next-item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(128, 507)
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>